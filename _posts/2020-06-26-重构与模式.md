---
layout: article
title: 重构与模式
tags: [Book]
key: 
---

书籍 [重构与模式](https://www.amazon.cn/dp/B01HZFH2W6/ref=sr_1_1?__mk_zh_CN=%E4%BA%9A%E9%A9%AC%E9%80%8A%E7%BD%91%E7%AB%99&keywords=%E9%87%8D%E6%9E%84%E4%B8%8E%E6%A8%A1%E5%BC%8F&qid=1593157157&s=digital-text&sr=1-1) 读书笔记.

## 何为重构

## 何为模式

## 重构场景

## 重构示例

> 注意在重构步骤中的每一小步中运行测试, 以保证重构安全.

### Creation Method 重构

用能够说明意图的返回对象实例的 Creation Method 替换构造函数.

#### 重构步骤

1. 采用提炼函数重构, 在客户代码中找到构造函数的调用, 将此转变为对公共, 静态的 Creation Method 调用.
2. 采用搬移函数重构, 将 Creation Method 搬移到构造函数对应的类中.
3. 在客户代码中将所有对封装的构造函数的调用转变为对 Creation Method 的调用
4. 采用内联构造函数重构, 将 Creation Method 改造成只调用一次构造函数, 防止构造函数嵌套调用.
5. 对需要改造成 Creation Method 调用的构造方法, 重复上述步骤.
6. 将类中无外部调用的构造函数改为非私有的.

#### 示例

重构前:

```java
package org.example.creation_method.original;

import org.example.creation_method.CapitalStrategy;
import org.example.creation_method.CapitalStrategyRCTL;
import org.example.creation_method.CapitalStrategyRevolver;
import org.example.creation_method.CapitalStrategyTermLoan;

import java.util.Date;

/**
 * 贷款类, 可以表示 7 种, 这里只讨论 3 中
 *
 * <ol>
 *     <li>定期贷款(Term Load)</li>
 *     <li>循环贷款(Revolver Load)</li>
 *     <li>循环信用定期贷款(Revolving credit term load, RCTL)</li>
 * </ol>
 * <p>
 * 没有用子类表示各种贷款是因为
 * <ol>
 *     <li>区分不同贷款的并不是它们的字段, 而是计算资金(capital), 收益(income), 期限(duration)</li>
 *     <li>不同种类的贷款需要支持互相转换</li>
 * </ol>
 */
public class Loan {
    private double commitment;
    private double outstanding;
    private int riskRating;
    private Date maturity;
    private Date expiry;
    private CapitalStrategy capitalStrategy;

    // 省略 getter setter 方法

    public Loan(double commitment, int riskRating, Date maturity) {
        this(commitment, 0.00, riskRating, maturity, null);
    }

    public Loan(double commitment, int riskRating, Date maturity, Date expiry) {
        this(commitment, 0.00, riskRating, maturity, expiry);
    }

    public Loan(double commitment, double outstanding, int riskRating, Date maturity, Date expiry) {
        this(commitment, outstanding, riskRating, maturity, expiry, null);
    }

    public Loan(double commitment, int riskRating, Date maturity, Date expiry, CapitalStrategy capitalStrategy) {
        this(commitment, 0.00, riskRating, maturity, expiry, capitalStrategy);
    }

    public Loan(double commitment, double outstanding, int riskRating, Date maturity, Date expiry, CapitalStrategy capitalStrategy) {
        this.commitment = commitment;
        this.outstanding = outstanding;
        this.riskRating = riskRating;
        this.maturity = maturity;
        this.expiry = expiry;
        this.capitalStrategy = capitalStrategy;

        if (capitalStrategy == null) {
            if (expiry == null)
                this.capitalStrategy = new CapitalStrategyTermLoan();
            else if (maturity == null)
                this.capitalStrategy = new CapitalStrategyRevolver();
            else
                this.capitalStrategy = new CapitalStrategyRCTL();
        }
    }
}
```

重构后:

```java
public class Loan {
    private double commitment;
    private double outstanding;
    private int riskRating;
    private Date maturity;
    private Date expiry;
    private CapitalStrategy capitalStrategy;
    // 省略 getter setter 方法

    private Loan(double commitment, double outstanding, int riskRating, Date maturity, Date expiry, CapitalStrategy capitalStrategy) {
        this.commitment = commitment;
        this.outstanding = outstanding;
        this.riskRating = riskRating;
        this.maturity = maturity;
        this.expiry = expiry;
        this.capitalStrategy = capitalStrategy;

        if (capitalStrategy == null) {
            if (expiry == null)
                this.capitalStrategy = new CapitalStrategyTermLoan();
            else if (maturity == null)
                this.capitalStrategy = new CapitalStrategyRevolver();
            else
                this.capitalStrategy = new CapitalStrategyRCTL();
        }
    }

    static Loan createTermLoan(double commitment, int riskRating, Date maturity) {
        return new Loan(commitment, 0.00, riskRating, maturity, null, new CapitalStrategyTermLoan());
    }

    static Loan createTermLoanWithAdjustedCapitalStrategy(double commitment, double outstanding, int riskRating, Date maturity, CapitalStrategy riskAdjustedCapitalStrategy) {
        return new Loan(commitment, outstanding, riskRating, maturity, null, riskAdjustedCapitalStrategy);
    }

    static Loan createRevolverLoan(double commitment, double outstanding, int riskRating, Date maturity, Date expiry) {
        return new Loan(commitment, outstanding, riskRating, maturity, expiry, null);
    }

    static Loan createRevolverWithCapitalStrategy(double commitment, double outstanding, int riskRating, Date maturity, Date expiry, CapitalStrategy capitalStrategy) {
        return new Loan(commitment, outstanding, riskRating, maturity, expiry, capitalStrategy);
    }

    static Loan createRCTLLoan(double commitment, double outstanding, int riskRating, Date maturity, Date expiry) {
        return new Loan(commitment, outstanding, riskRating, maturity, expiry, null);
    }

    static Loan createRCTLLoanWithCapitalStrategy(double commitment, int riskRating, Date maturity, Date expiry, CapitalStrategy capitalStrategy) {
        return new Loan(commitment, 0.00, riskRating, maturity, expiry, capitalStrategy);
    }

    static Loan createRCTLLoanWithExpiry(double commitment, int riskRating, Date maturity, Date expiry) {
        return new Loan(commitment, 0.00, riskRating, maturity, expiry, null);
    }
}
```

### Factory 重构

将有关创建的知识搬移到一个 Factory 类中.

#### 重构步骤

1. 采用 Creation Method 重构, 将类的实例化转移到静态方法.
2. 创建工厂类, 采用搬移函数重构将 Creation Method 搬移到工厂类中, 将 Creation Method 改为非静态的.
3. 将实例化类修改为实例化工厂对象, 并调用 Creation Method 获取实例对象.

#### 示例